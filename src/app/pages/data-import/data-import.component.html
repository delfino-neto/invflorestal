<div class="p-fluid p-mt-4 p-mb-4">

    <div class="page-header">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
        <span class="breadcrumb-item">Dados</span>
        <i class="pi pi-angle-right breadcrumb-separator"></i>
        <span class="breadcrumb-item breadcrumb-current">Importação</span>
        </div>

        <!-- Título e Ações -->
        <div class="header-main">
        <div class="header-title-section">
            <h1 class="page-title">Importar Espécimes</h1>
        </div>
        <div class="header-actions">
        </div>
        </div>
    </div>

    <div class="card">
        <!-- Form Section -->
        <div class="form-section p-2 mb-4">
            <!-- File Upload -->
            <div class="field">
                <label class="block font-semibold mb-2">
                    <i class="pi pi-file mr-2"></i>Arquivo
                </label>
                
                <div class="upload-container" [class.has-file]="selectedFile">
                    <div *ngIf="!selectedFile" class="upload-area">
                        <i class="pi pi-cloud-upload upload-icon"></i>
                        <p class="upload-text mb-4">Arraste um arquivo ou clique para selecionar</p>
                        <p-fileUpload 
                            mode="basic" 
                            name="file"
                            [auto]="false"
                            accept=".csv,.xlsx,.xls"
                            [maxFileSize]="10000000"
                            chooseLabel="Escolher Arquivo"
                            (onSelect)="onFileSelect($event)"
                            [disabled]="uploading"
                            class="mt-4">
                        </p-fileUpload>
                        <small class="text-color-secondary mt-4">CSV, XLSX ou XLS (máx. 10MB)</small>
                    </div>
                    
                    <div *ngIf="selectedFile" class="file-selected">
                        <div class="file-info">
                            <i class="pi pi-file-excel text-green-600" [style]="{'font-size': '20pt'}"></i>
                            <div class="file-details">
                                <span class="file-name">{{ selectedFile.name }}</span>
                                <span class="file-size">{{ (selectedFile.size / 1024).toFixed(2) }} KB</span>
                            </div>
                        </div>
                        <p-button 
                            icon="pi pi-times" 
                            [text]="true"
                            [rounded]="true"
                            severity="danger"
                            size="small"
                            (onClick)="onFileRemove()"
                            [disabled]="uploading">
                        </p-button>
                    </div>
                </div>
            </div>

            <p-divider></p-divider>

            <!-- Preview Section -->
            <div class="card mb-4" *ngIf="filePreview && filePreview.length > 0">
                <div class="flex gap-2 mb-3 items-center">
                    <i class="pi bg-gray-300 p-2 rounded-md pi-file-excel text-xl"></i>
                    <div class="m-0 text-xl font-bold">Preview do Arquivo</div>
                    <p-tag [value]="filePreview.length + ' linhas'" severity="info"></p-tag>
                </div>

                <p-table 
                    [showGridlines]="true"
                    [stripedRows]="true"
                    [value]="filePreview" 
                    [scrollable]="true"
                    scrollHeight="400px"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 60px; text-align: center;">#</th>
                        <th *ngFor="let col of previewColumns; let i = index" style="min-width: 150px;">
                        Col {{ i }}
                        </th>
                    </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
                    <tr>
                        <td class="text-center" style="background: var(--surface-50)">
                        {{ rowIndex }}
                        </td>
                        <td *ngFor="let col of previewColumns">
                        {{ row[col] || '-' }}
                        </td>
                    </tr>
                    </ng-template>
                </p-table>
            </div>

                <!-- Configuration Form -->
                <form [formGroup]="importForm" class="flex gap-4">

                    <div class="flex flex-col flex-1">

                        <div class="flex gap-4">
                            <div class="field flex-1">
                                <label for="collectionArea" class="block font-semibold mb-2">
                                    <i class="pi pi-map mr-2"></i>Área de Coleta <span class="text-red-500">*</span>
                                </label>
                                <p-select
                                    id="collectionArea"
                                    formControlName="collectionAreaId"
                                    [options]="collectionAreas"
                                    optionLabel="name"
                                    optionValue="id"
                                    placeholder="Selecione a área de coleta"
                                    (onChange)="onCollectionAreaChange()"
                                    [disabled]="uploading">
                                </p-select>
                                <small class="block mt-1 text-color-secondary">Selecione primeiro a área de coleta</small>
                            </div>
    
                            <div class="field flex-1">
                                <label for="plot" class="block font-semibold mb-2">
                                    <i class="pi pi-map-marker mr-2"></i>Plot <span class="text-red-500">*</span>
                                </label>
                                <p-select
                                    id="plot"
                                    formControlName="plotId"
                                    [options]="filteredPlots"
                                    optionLabel="plotCode"
                                    optionValue="id"
                                    placeholder="Selecione o plot"
                                    [disabled]="uploading || !importForm.get('collectionAreaId')?.value">
                                </p-select>
                                <small class="block mt-1 text-color-secondary">Plot onde os espécimes serão cadastrados</small>
                            </div>
                        </div>
        
                        <div class="flex gap-4">
                            <div class="field col-6">
                            <label for="startRow" class="block font-semibold mb-2">Linha Inicial</label>
                            <p-inputNumber
                                id="startRow"
                                formControlName="startRow"
                                styleClass="w-full"
                                [min]="0"
                                [disabled]="uploading">
                            </p-inputNumber>
                            </div>
        
                            <div class="field col-6">
                            <label for="sheetName" class="block font-semibold mb-2">Planilha (XLSX)</label>
                            <input
                                pInputText
                                id="sheetName"
                                formControlName="sheetName"
                                placeholder="Sheet #01"
                                class="w-full"
                                [disabled]="uploading">
                            </div>
                        </div>
        
                        <div class="field">
                            <div class="flex align-items-center">
                            <p-checkbox
                                formControlName="autoCreateSpecies"
                                [binary]="true"
                                inputId="autoCreate"
                                [disabled]="uploading">
                            </p-checkbox>
                            <label for="autoCreate" class="ml-2 cursor-pointer">Criar espécies automaticamente</label>
                            </div>
                        </div>
                    </div>


                    <!-- Column Mapping -->
                    <div class="field" [style]="{'width': '50%'}">
                        <label class="block font-semibold mb-2">
                        Mapeamento de Colunas
                        </label>
                        
                        <div class="mapping-list">
                        <div *ngFor="let mapping of columnMappings; let i = index" class="mapping-item">
                            <div class="mapping-fields">
                            <div class="field-col">
                                <label class="field-label">Coluna</label>
                                <p-inputNumber
                                [(ngModel)]="mapping.columnIndex"
                                [ngModelOptions]="{standalone: true}"
                                placeholder="0"
                                [min]="0"
                                [showButtons]="true"
                                [disabled]="uploading">
                                </p-inputNumber>
                            </div>
                            
                            <div class="field-col field-grow">
                                <label class="field-label">Campo</label>
                                <p-select
                                [(ngModel)]="mapping.fieldName"
                                [ngModelOptions]="{standalone: true}"
                                [options]="availableFields"
                                optionLabel="label"
                                optionValue="value"
                                placeholder="Selecione o campo"
                                [disabled]="uploading">
                                </p-select>
                            </div>
                            
                            <p-button
                                icon="pi pi-trash"
                                [text]="true"
                                [rounded]="true"
                                severity="danger"
                                size="small"
                                (onClick)="removeColumnMapping(i)"
                                [disabled]="uploading || columnMappings.length <= 1"
                                class="delete-btn">
                            </p-button>
                            </div>
                        </div>
                        </div>

                        <p-button
                        label="Adicionar Coluna"
                        icon="pi pi-plus"
                        [outlined]="true"
                        size="small"
                        class="w-full mt-2"
                        (onClick)="addColumnMapping()"
                        [disabled]="uploading">
                        </p-button>
                    </div>
                </form>

                <!-- Actions -->
                <div class="flex gap-2 mt-4">
                <p-button
                    label="Limpar"
                    icon="pi pi-times"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="reset()"
                    [disabled]="uploading">
                </p-button>
                <p-button
                    label="Importar Dados"
                    icon="pi pi-upload"
                    (onClick)="importData()"
                    [disabled]="!canImport()"
                    [loading]="uploading">
                </p-button>
                </div>

                <!-- Progress -->
                <div *ngIf="uploading" class="mt-3">
                <p-progressBar mode="indeterminate"></p-progressBar>
                <p class="text-center text-color-secondary text-sm mt-2">Processando arquivo...</p>
                </div>
            </div>

        <!-- Results Section -->
        <div *ngIf="importResult && !uploading" class="mt-4">
        <p-divider></p-divider>
        
        <h4><i class="pi pi-check-circle text-green-500 mr-2"></i>Resultado da Importação</h4>
        
        <div class="grid mt-3">
            <div class="col-12 md:col-3">
            <div class="surface-50 border-round p-3 text-center">
                <div class="text-4xl font-bold text-primary">{{ importResult.totalRows }}</div>
                <div class="text-color-secondary mt-2">Total</div>
            </div>
            </div>
            <div class="col-12 md:col-3">
            <div class="surface-50 border-round p-3 text-center">
                <div class="text-4xl font-bold text-green-600">{{ importResult.successCount }}</div>
                <div class="text-color-secondary mt-2">Sucessos</div>
            </div>
            </div>
            <div class="col-12 md:col-3">
            <div class="surface-50 border-round p-3 text-center">
                <div class="text-4xl font-bold text-red-600">{{ importResult.errorCount }}</div>
                <div class="text-color-secondary mt-2">Erros</div>
            </div>
            </div>
            <div class="col-12 md:col-3">
            <div class="surface-50 border-round p-3 text-center">
                <div class="text-4xl font-bold text-blue-600">{{ importResult.speciesCreated }}</div>
                <div class="text-color-secondary mt-2">Espécies Criadas</div>
            </div>
            </div>
        </div>

        <div *ngIf="importResult.executionTimeMs" class="text-center text-color-secondary mt-3">
            <i class="pi pi-clock mr-1"></i>
            Tempo de execução: {{ importResult.executionTimeMs }}ms
        </div>

        <!-- Errors Table -->
        <div *ngIf="importResult.errors && importResult.errors.length > 0" class="mt-4">
            <h5 class="text-orange-600">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Erros Encontrados
            </h5>
            <p-table 
            [value]="importResult.errors" 
            [paginator]="true" 
            [rows]="10"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} erros">
            <ng-template pTemplate="header">
                <tr>
                <th style="width: 80px">Linha</th>
                <th>Mensagem</th>
                <th>Dados</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-error>
                <tr>
                <td>
                    <p-tag [value]="error.rowNumber.toString()" severity="danger"></p-tag>
                </td>
                <td>{{ error.message }}</td>
                <td>
                    <small class="text-color-secondary">{{ error.rowData }}</small>
                </td>
                </tr>
            </ng-template>
            </p-table>
        </div>
        </div>
    </div>
</div>

<p-toast></p-toast>