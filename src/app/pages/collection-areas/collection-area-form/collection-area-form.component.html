<div class="collection-area-form-container">
  <!-- Header -->
  <div class="form-header">
    <div class="header-content">
      <div class="header-left">
        <div class="icon-wrapper">
          <i class="pi pi-map"></i>
        </div>
        <div class="header-text">
          <h1 class="header-title">
            {{ isEditMode ? 'Editar Área de Coleta' : 'Nova Área de Coleta' }}
          </h1>
          <p class="header-subtitle">
            {{ isEditMode ? 'Atualize as informações da área de inventário' : 'Desenhe e defina uma nova área de inventário florestal' }}
          </p>
        </div>
      </div>
      <div class="header-actions">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          [outlined]="true"
          (onClick)="onCancel()"
          [disabled]="isSubmitting"
        />
        <p-button
          label="Salvar Área"
          icon="pi pi-check"
          (onClick)="onSubmit()"
          [loading]="isSubmitting"
          [disabled]="form.invalid || !hasDrawnPolygon"
        />
      </div>
    </div>
  </div>

  <div class="form-content">
    <form [formGroup]="form">
      <div class="form-grid">
        <!-- Painel Esquerdo: Formulário -->
        <div class="form-panel">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header-custom">
                <i class="pi pi-info-circle text-xl"></i>
                <span class="font-semibold">Informações da Área</span>
              </div>
            </ng-template>

            <div class="form-fields">
              <!-- Nome -->
              <div class="form-field">
                <label for="name" class="form-label required">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Escolha um nome descritivo para identificar esta área" 
                     tooltipPosition="top"></i>
                  Nome da Área
                </label>
                <input
                  pInputText
                  id="name"
                  formControlName="name"
                  placeholder="Ex: Mata Atlântica - Zona A"
                  class="w-full"
                  [class.ng-invalid]="isFieldInvalid('name')"
                  [class.ng-dirty]="isFieldInvalid('name')"
                />
                <small class="form-error" *ngIf="isFieldInvalid('name')">
                  {{ getFieldError('name') }}
                </small>
              </div>

              <!-- Bioma -->
              <div class="form-field">
                <label for="biome" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Bioma brasileiro onde a área está localizada" 
                     tooltipPosition="top"></i>
                  Bioma
                </label>
                <p-autoComplete
                  id="biome"
                  formControlName="biome"
                  [suggestions]="filteredBiomes"
                  (completeMethod)="filterBiomes($event)"
                  placeholder="Ex: Mata Atlântica"
                  [dropdown]="true"
                  styleClass="w-full"
                />
              </div>

              <!-- Tipo de Vegetação -->
              <div class="form-field">
                <label for="vegetationType" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Tipo de formação vegetal predominante" 
                     tooltipPosition="top"></i>
                  Tipo de Vegetação
                </label>
                <p-autoComplete
                  id="vegetationType"
                  formControlName="vegetationType"
                  [suggestions]="filteredVegetationTypes"
                  (completeMethod)="filterVegetationTypes($event)"
                  placeholder="Ex: Floresta Ombrófila Densa"
                  [dropdown]="true"
                  styleClass="w-full"
                />
              </div>

              <!-- Clima -->
              <div class="form-field">
                <label for="climateZone" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Classificação climática da região" 
                     tooltipPosition="top"></i>
                  Zona Climática
                </label>
                <p-autoComplete
                  id="climateZone"
                  formControlName="climateZone"
                  [suggestions]="filteredClimates"
                  (completeMethod)="filterClimates($event)"
                  placeholder="Ex: Tropical úmido"
                  [dropdown]="true"
                  styleClass="w-full"
                />
              </div>

              <!-- Tipo de Solo -->
              <div class="form-field">
                <label for="soilType" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Tipo de solo predominante na área" 
                     tooltipPosition="top"></i>
                  Tipo de Solo
                </label>
                <p-autoComplete
                  id="soilType"
                  formControlName="soilType"
                  [suggestions]="filteredSoilTypes"
                  (completeMethod)="filterSoilTypes($event)"
                  placeholder="Ex: Latossolo"
                  [dropdown]="true"
                  styleClass="w-full"
                />
              </div>

              <!-- Status de Conservação -->
              <div class="form-field">
                <label for="conservationStatus" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Estado de conservação da vegetação" 
                     tooltipPosition="top"></i>
                  Status de Conservação
                </label>
                <p-autoComplete
                  id="conservationStatus"
                  formControlName="conservationStatus"
                  [suggestions]="filteredConservationStatus"
                  (completeMethod)="filterConservationStatus($event)"
                  placeholder="Ex: Preservada"
                  [dropdown]="true"
                  styleClass="w-full"
                />
              </div>

              <!-- Altitude -->
              <div class="form-field">
                <label for="altitudeM" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Altitude média da área em metros" 
                     tooltipPosition="top"></i>
                  Altitude (metros)
                </label>
                <p-inputNumber
                  id="altitudeM"
                  formControlName="altitudeM"
                  placeholder="Ex: 850"
                  [min]="0"
                  [max]="10000"
                  suffix=" m"
                  styleClass="w-full"
                />
              </div>

              <!-- Área Protegida -->
              <div class="form-field">
                <div class="flex items-center gap-2">
                  <p-checkbox
                    inputId="protectedArea"
                    formControlName="protectedArea"
                    [binary]="true"
                  />
                  <label for="protectedArea" class="form-label mb-0 cursor-pointer">
                    <i class="pi pi-info-circle info-icon" 
                       pTooltip="Marque se é uma Unidade de Conservação ou Terra Indígena" 
                       tooltipPosition="top"></i>
                    Área Protegida
                  </label>
                </div>
              </div>

              <!-- Nome da Área Protegida -->
              <div class="form-field" *ngIf="form.get('protectedArea')?.value">
                <label for="protectedAreaName" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Nome da UC, TI ou outra categoria de área protegida" 
                     tooltipPosition="top"></i>
                  Nome da Área Protegida
                </label>
                <input
                  pInputText
                  id="protectedAreaName"
                  formControlName="protectedAreaName"
                  placeholder="Ex: Parque Nacional da Serra do Mar"
                  class="w-full"
                />
              </div>

              <!-- Proprietário/Responsável -->
              <div class="form-field">
                <label for="landOwner" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Proprietário da terra ou responsável pela gestão" 
                     tooltipPosition="top"></i>
                  Proprietário/Responsável
                </label>
                <input
                  pInputText
                  id="landOwner"
                  formControlName="landOwner"
                  placeholder="Ex: Instituto Ambiental XYZ"
                  class="w-full"
                />
              </div>

              <!-- Notas -->
              <div class="form-field">
                <label for="notes" class="form-label">
                  <i class="pi pi-info-circle info-icon" 
                     pTooltip="Informações adicionais sobre acesso, características especiais, etc." 
                     tooltipPosition="top"></i>
                  Observações
                </label>
                <textarea
                  id="notes"
                  pTextarea
                  formControlName="notes"
                  placeholder="Adicione informações relevantes sobre esta área..."
                  rows="5"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                ></textarea>
              </div>

              <!-- Status do Polígono -->
              <div class="polygon-status">
                <p-divider />
                <div class="status-indicator">
                  <i 
                    class="pi text-2xl"
                    [class.pi-map]="!hasDrawnPolygon"
                    [class.pi-check-circle]="hasDrawnPolygon"
                    [class.text-gray-400]="!hasDrawnPolygon"
                    [class.text-emerald-500]="hasDrawnPolygon"
                  ></i>
                  <div>
                    <p class="font-semibold text-gray-800 dark:text-gray-100">
                      {{ hasDrawnPolygon ? 'Polígono Desenhado' : 'Aguardando Desenho' }}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      {{ hasDrawnPolygon 
                        ? 'Você pode ajustar arrastando os pontos no mapa' 
                        : 'Use o mapa ao lado para desenhar a área de coleta' 
                      }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </p-card>
        </div>

        <!-- Painel Direito: Mapa -->
        <div class="map-panel">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header-custom">
                <i class="pi pi-map text-xl"></i>
                <span class="font-semibold">Desenho da Área</span>
              </div>
            </ng-template>

            <div class="map-container-wrapper">
              <!-- Modal de Instruções com Backdrop -->
              <div class="instructions-modal" *ngIf="showInstructions" [@fadeInOut]>
                <!-- Backdrop -->
                <div class="modal-backdrop" (click)="onBackdropClick()"></div>
                
                <!-- Modal Content -->
                <div class="modal-content" (click)="$event.stopPropagation()">
                  <div class="modal-header">
                    <div class="icon-wrapper">
                      <i class="pi pi-map"></i>
                    </div>
                    <h3 class="modal-title">Desenhe a área no mapa</h3>
                    <p class="modal-subtitle">Siga os passos abaixo para criar o polígono</p>
                  </div>
                  
                  <div class="modal-body">
                    <div class="instruction-item" *ngFor="let instruction of drawingInstructions; let i = index">
                      <div class="step-number">{{ i + 1 }}</div>
                      <span class="step-text">{{ instruction }}</span>
                    </div>
                    
                    <div class="instructions-tip">
                      <i class="pi pi-info-circle"></i>
                      <span>Você pode ajustar arrastando os pontos depois</span>
                    </div>
                  </div>
                  
                  <div class="modal-footer">
                    <p-button
                      label="Entendi"
                      icon="pi pi-check"
                      (onClick)="closeInstructions()"
                      [outlined]="false"
                    />
                  </div>
                </div>
              </div>

              <!-- Componente de Mapa -->
              <app-geometry-map 
                formControlName="geometry"
                [height]="'calc(100vh - 300px)'"
                [minHeight]="'600px'"
                (geometryChange)="onGeometryChange($event)"
              />
            </div>
          </p-card>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Toast para mensagens -->
<p-toast position="top-right" />
