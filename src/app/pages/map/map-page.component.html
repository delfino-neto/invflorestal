<div class="map-page-container">
  <!-- Top Bar - Filtros -->
  <div class="filter-bar bg-white border-b border-gray-200 shadow-sm">
    <div class="px-6 py-4">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="flex items-center gap-2">
          <i class="pi pi-filter text-gray-600"></i>
          <span class="text-lg font-semibold text-gray-800">Filtros</span>
        </div>

        <div class="flex-1 flex items-center gap-4 flex-wrap">
          <!-- Filtro por Espécie -->
          <div class="filter-item">
            <label class="block text-sm font-medium text-gray-700 mb-1">Espécie</label>
            <p-select
              [(ngModel)]="selectedSpecies"
              (onChange)="onFilterChange()"
              [options]="speciesList"
              optionLabel="scientificName"
              placeholder="Todas as espécies"
              [filter]="true"
              filterBy="scientificName,commonName"
              [showClear]="true"
              styleClass="w-64"
            >
              <ng-template pTemplate="selectedItem">
                @if (selectedSpecies) {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-leaf text-green-600"></i>
                    <span class="font-medium">{{ selectedSpecies.scientificName }}</span>
                  </div>
                }
              </ng-template>
              <ng-template let-species pTemplate="item">
                <div class="flex flex-col py-1">
                  <span class="font-medium text-gray-900">{{ species.scientificName }}</span>
                  <span class="text-sm text-gray-500">{{ species.commonName }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>

          <!-- Filtro por Área -->
          <div class="filter-item">
            <label class="block text-sm font-medium text-gray-700 mb-1">Área de Coleta</label>
            <p-select
              [(ngModel)]="selectedArea"
              (onChange)="onFilterChange()"
              [options]="areasList"
              optionLabel="name"
              placeholder="Todas as áreas"
              [filter]="true"
              filterBy="name,code"
              [showClear]="true"
              styleClass="w-64"
            >
              <ng-template pTemplate="selectedItem">
                @if (selectedArea) {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-map-marker text-blue-600"></i>
                    <span class="font-medium">{{ selectedArea.name }}</span>
                  </div>
                }
              </ng-template>
              <ng-template let-area pTemplate="item">
                <div class="flex flex-col py-1">
                  <span class="font-medium text-gray-900">{{ area.name }}</span>
                  <span class="text-sm text-gray-500">{{ area.code }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>

          <!-- Filtro por Observador -->
          <div class="filter-item">
            <label class="block text-sm font-medium text-gray-700 mb-1">Observador</label>
            <p-select
              [(ngModel)]="selectedObserver"
              (onChange)="onFilterChange()"
              [options]="observersList"
              optionLabel="name"
              placeholder="Todos os observadores"
              [filter]="true"
              filterBy="name,email"
              [showClear]="true"
              styleClass="w-64"
            >
              <ng-template pTemplate="selectedItem">
                @if (selectedObserver) {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-user text-purple-600"></i>
                    <span class="font-medium">{{ selectedObserver.name }}</span>
                  </div>
                }
              </ng-template>
              <ng-template let-user pTemplate="item">
                <div class="flex flex-col py-1">
                  <span class="font-medium text-gray-900">{{ user.name }}</span>
                  <span class="text-sm text-gray-500">{{ user.email }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>

          <!-- Botões -->
          <div class="flex items-end gap-2 ml-auto">
            <p-button
              label="Limpar"
              icon="pi pi-times"
              (onClick)="clearFilters()"
              [disabled]="loading || (!selectedSpecies && !selectedArea && !selectedObserver)"
              styleClass="p-button-outlined p-button-secondary"
              pTooltip="Limpar todos os filtros"
              tooltipPosition="bottom"
            ></p-button>
          </div>
        </div>
      </div>

      <!-- Contador de resultados -->
      <div class="mt-3 pt-3 border-t border-gray-100">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="pi pi-info-circle"></i>
          @if (!loading) {
            <span>
              <strong class="text-gray-900">{{ specimens.length }}</strong> 
              {{ specimens.length === 1 ? 'espécime encontrado' : 'espécimes encontrados' }}
            </span>
          }
          @if (loading) {
            <span class="flex items-center gap-2">
              <i class="pi pi-spin pi-spinner"></i>
              Carregando espécimes...
            </span>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Mapa -->
  <div class="map-container">
    <!-- Controles do mapa -->
    <div class="map-controls">
      <p-button
        icon="pi pi-refresh"
        (onClick)="resetMapView()"
        [rounded]="true"
        severity="secondary"
        pTooltip="Ajustar visualização"
        tooltipPosition="left"
      ></p-button>
    </div>

    @if (loading && initialLoad) {
      <div class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
          <p-progressSpinner 
            styleClass="w-16 h-16"
            strokeWidth="4"
            fill="transparent"
            animationDuration=".8s"
          ></p-progressSpinner>
          <span class="text-lg font-medium text-gray-700">Carregando mapa...</span>
        </div>
      </div>
    }

    @if (!initialLoad) {
      <app-map-visualizer
        [height]="'100%'"
        [centerLat]="centerLat"
        [centerLon]="centerLon"
        [initialZoom]="initialZoom"
        [markers]="markers"
        [enableClustering]="true"
        [clusterDistance]="50"
        [maxZoom]="18"
      ></app-map-visualizer>
    }

    <!-- Mensagem quando não há espécimes -->
    @if (!loading && !initialLoad && specimens.length === 0) {
      <div class="empty-state">
        <div class="flex flex-col items-center gap-4 text-center">
          <i class="pi pi-map text-6xl text-gray-400"></i>
          <div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Nenhum espécime encontrado</h3>
            <p class="text-gray-600">
              Tente ajustar os filtros para visualizar espécimes no mapa
            </p>
          </div>
          <p-button
            label="Limpar Filtros"
            icon="pi pi-refresh"
            (onClick)="clearFilters()"
            styleClass="p-button-outlined"
          ></p-button>
        </div>
      </div>
    }
  </div>

  <!-- Drawer de Detalhes do Espécime -->
  <p-drawer
    [(visible)]="showSpecimenDetails"
    position="right"
    [style]="{ width: '24rem' }"
    [modal]="true"
  >
    <ng-template pTemplate="header">
      <div class="drawer-header">
        <h3 class="drawer-title">Detalhes do Espécime</h3>
        <span class="drawer-subtitle">ID #{{ selectedSpecimen?.id }}</span>
      </div>
    </ng-template>

    @if (selectedSpecimen) {
      <div class="drawer-content">
        <!-- Espécie -->
        <div class="drawer-section">
          <h4 class="section-title">Espécie</h4>
          <div class="section-content">
            <div class="field-group">
              <label class="field-label">Nome Científico</label>
              <p class="field-value field-value-primary">{{ selectedSpecimen.speciesScientificName || 'N/A' }}</p>
            </div>
            <div class="field-group">
              <label class="field-label">Nome Comum</label>
              <p class="field-value">{{ selectedSpecimen.speciesCommonName || 'N/A' }}</p>
            </div>
          </div>
        </div>

        <!-- Localização -->
        <div class="drawer-section">
          <h4 class="section-title">Localização</h4>
          <div class="section-content">
            <div class="field-group">
              <label class="field-label">Área de Coleta</label>
              <p class="field-value">{{ selectedSpecimen.areaName || 'N/A' }}</p>
            </div>
            <div class="field-group">
              <label class="field-label">Parcela</label>
              <p class="field-value">{{ selectedSpecimen.plotCode || 'N/A' }}</p>
            </div>
            <div class="field-row">
              <div class="field-group">
                <label class="field-label">Latitude</label>
                <p class="field-value field-value-mono">{{ formatCoordinate(selectedSpecimen.latitude) }}</p>
              </div>
              <div class="field-group">
                <label class="field-label">Longitude</label>
                <p class="field-value field-value-mono">{{ formatCoordinate(selectedSpecimen.longitude) }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Observador -->
        <div class="drawer-section">
          <h4 class="section-title">Observador</h4>
          <div class="section-content">
            <div class="observer-info">
              <p-avatar 
                  class="metadata-avatar"
                  [label]="getInitials(selectedSpecimen.observerFullName ?? 'N/A')" 
                  shape="square"
                  [style]="{ 'background-color': getUserAvatarColor(selectedSpecimen.observerFullName ?? 'N/A'), 'color': '#ffffff' }"
              ></p-avatar>
              <p class="field-value">{{ selectedSpecimen.observerFullName || 'N/A' }}</p>
            </div>
          </div>
        </div>

        <!-- Datas -->
        <div class="drawer-section">
          <h4 class="section-title">Registro</h4>
          <div class="section-content">
            <div class="field-group">
              <label class="field-label">Criado em</label>
              <p class="field-value">{{ formatDate(selectedSpecimen.createdAt) }}</p>
            </div>
            <div class="field-group">
              <label class="field-label">Atualizado em</label>
              <p class="field-value">{{ formatDate(selectedSpecimen.updatedAt) }}</p>
            </div>
          </div>
        </div>

        <!-- Imagens -->
        @if (selectedSpecimen.imageUrls && selectedSpecimen.imageUrls.length > 0) {
          <div class="drawer-section">
            <h4 class="section-title">Imagens ({{ selectedSpecimen.imageUrls.length }})</h4>
            <div class="section-content">
              <div class="image-grid">
                @for (imageUrl of selectedSpecimen.imageUrls; track imageUrl) {
                  <div class="image-item">
                    <img [src]="'/api'+imageUrl" [alt]="selectedSpecimen.speciesScientificName" />
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }
  </p-drawer>

  <!-- Popover de Seleção (Cluster) - Estilo Elegante -->
  <p-popover #clusterPopover [dismissable]="true">
    <div class="cluster-menu">
      <span class="font-medium block mb-2">Objetos nessa localização</span>
      <div class="cluster-menu-items">
        @for (specimen of clusterSpecimens; track specimen.id) {
          <button 
            class="cluster-menu-item"
            (click)="selectSpecimenFromCluster(specimen)"
          >
            <div class="cluster-avatar">
              <i class="material-symbols-outlined" [style]="{'font-size': '10pt'}">potted_plant</i>
            </div>
            <div class="cluster-menu-content">
              <span class="cluster-species-name">{{ specimen.speciesScientificName ?? 'Espécie não identificada' }}</span>
              <span class="cluster-area-name">{{ specimen.areaName }}</span>
            </div>
          </button>
        }
      </div>
    </div>
  </p-popover>
</div>