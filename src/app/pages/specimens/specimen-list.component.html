<div class="specimen-list-container">
  <p-toast />
  <p-confirmDialog />

  <!-- Header -->
  <div class="page-header">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <span class="breadcrumb-item">Cadastros</span>
      <i class="pi pi-angle-right breadcrumb-separator"></i>
      <span class="breadcrumb-item breadcrumb-current">Espécimes</span>
    </div>

    <!-- Título e Ações -->
    <div class="header-main">
      <div class="header-title-section">
        <h1 class="page-title">Espécimes</h1>
      </div>
      <div class="header-actions">
        <button
          pButton
          icon="pi pi-plus"
          label="Novo Espécime"
          severity="primary"
          (click)="navigateToNew()"
        ></button>
      </div>
    </div>
  </div>

  <!-- Search and Controls -->
  <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-6">
    <p-iconfield iconPosition="left" class="w-full md:w-96">
      <p-inputicon styleClass="pi pi-search" />
      <input
        type="text"
        pInputText
        [(ngModel)]="searchTerm"
        (input)="onSearch($event)"
        placeholder="Buscar por espécie, parcela ou observador..."
        class="w-full"
      />
    </p-iconfield>
  </div>

  <!-- DataView -->
  <p-dataView
    #dv
    [value]="specimens"
    [layout]="layout"
    [paginator]="false"
    [loading]="loading"
  >
    <!-- Empty State -->
    <ng-template pTemplate="empty">
      <div class="empty-state flex flex-col items-center justify-center py-20">
        <i class="pi pi-sitemap text-8xl text-surface-300 dark:text-surface-700 mb-6"></i>
        <h3 class="text-2xl font-semibold text-surface-700 dark:text-surface-300 mb-2">
          Nenhum espécime encontrado
        </h3>
        <p class="text-surface-500 dark:text-surface-400 mb-6">
          Comece cadastrando os espécimes encontrados no inventário florestal
        </p>
        <button
          pButton
          icon="pi pi-plus"
          label="Cadastrar Primeiro Espécime"
          class="p-button-lg"
          (click)="navigateToNew()"
        ></button>
      </div>
    </ng-template>

    <!-- Grid View Template -->
    <ng-template let-specimens #grid>
      <div class="col-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <div *ngFor="let specimen of specimens">
            <div class="specimen-card">
              <!-- Galeria de Imagens (3/5 = 60%) -->
              <div class="specimen-carousel">
                <p-galleria 
                  *ngIf="specimen.imageUrls && specimen.imageUrls.length > 0; else noImages"
                  [value]="specimen.imageUrls" 
                  [numVisible]="1"
                  [circular]="true"
                  [autoPlay]="true"
                  [transitionInterval]="3000"
                  [showThumbnails]="false"
                  [showItemNavigators]="specimen.imageUrls.length > 1"
                  [showIndicators]="specimen.imageUrls.length > 1"
                  [containerStyle]="{'max-width': '100%'}"
                  [containerClass]="'galleria-container'">
                  <ng-template pTemplate="item" let-item>
                    <div class="galleria-image-container">
                      <img [src]="'/api'+item" [alt]="specimen.speciesScientificName" class="galleria-image" />
                    </div>
                  </ng-template>
                </p-galleria>
                <ng-template #noImages>
                  <div class="no-image-placeholder">
                    <i class="pi pi-image"></i>
                    <span>Sem imagens</span>
                  </div>
                </ng-template>
                
                <!-- Badge de ID sobreposto -->
                <div class="specimen-id-badge">
                  <p-tag value="ID: {{ specimen.id }}" severity="secondary" />
                </div>
              </div>

              <!-- Detalhes do Espécime (2/5 = 40%) -->
              <div class="specimen-details-section">
                <!-- Espécie -->
                <div class="species-info">
                  <i class="pi pi-leaf"></i>
                  <div class="flex-1">
                    <h3 class="species-name">{{ specimen.speciesScientificName }}</h3>
                    <p class="common-name">{{ specimen.speciesCommonName || 'Nome comum não disponível' }}</p>
                  </div>
                </div>

                <!-- Informações Compactas em Grid 2x2 -->
                <div class="compact-info-grid">
                  <!-- Área -->
                  <div class="info-item">
                    <i class="pi pi-map"></i>
                    <div class="info-content">
                      <span class="info-label">Área</span>
                      <span class="info-value">{{ specimen.areaName || 'N/A' }}</span>
                    </div>
                  </div>

                  <!-- Parcela -->
                  <div class="info-item">
                    <i class="pi pi-th-large"></i>
                    <div class="info-content">
                      <span class="info-label">Parcela</span>
                      <span class="info-value">{{ specimen.plotCode || '#' + specimen.plotId }}</span>
                    </div>
                  </div>

                  <!-- Coordenadas -->
                  <div class="info-item">
                    <i class="pi pi-map-marker"></i>
                    <div class="info-content">
                      <span class="info-label">Coordenadas</span>
                      <span class="info-value">{{ formatCoordinates(specimen.latitude, specimen.longitude) }}</span>
                    </div>
                  </div>
                </div>

                <div class="user-info">
                    <p-avatar 
                        [label]="getInitials(specimen.observerFullName)" 
                        shape="square"
                        styleClass="metadata-avatar"
                        [style]="{ 'background-color': getUserAvatarColor(specimen.observerFullName) }"
                    ></p-avatar>
                    <div class="user-details">
                        <span class="user-name">{{ specimen.observerFullName || 'N/A' }}</span>
                        <span class="date-info">
                        <i class="pi pi-calendar-plus"></i>
                        {{ specimen.updatedAt ? formatDate(specimen.updatedAt) : formatDate(specimen.createdAt) }}
                        </span>
                    </div>
                </div>

                <!-- Ações -->
                <div class="card-actions">
                  <button
                    pButton
                    icon="pi pi-eye"
                    label="Ver"
                    class="p-button-outlined p-button-sm flex-1"
                    (click)="navigateToView(specimen.id!)"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-outlined p-button-warning p-button-sm"
                    (click)="navigateToEdit(specimen.id!)"
                    pTooltip="Editar"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-trash"
                    class="p-button-outlined p-button-danger p-button-sm"
                    (click)="confirmDelete(specimen)"
                    pTooltip="Excluir"
                  ></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </p-dataView>

  <!-- Paginador Separado -->
  <div *ngIf="!loading && specimens.length > 0" class="mt-8">
    <p-paginator
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[12, 24, 36]"
      (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} espécimes"
    ></p-paginator>
  </div>
</div>
