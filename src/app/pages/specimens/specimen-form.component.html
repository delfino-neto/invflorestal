<div class="specimen-form-container p-6">
  <p-toast />

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-2 flex items-center gap-3">
        <i [style]="{'font-size': '2rem'}" class="material-symbols-outlined text-primary">potted_plant</i>
        {{ isEditMode ? 'Editar' : 'Novo' }} Espécime
      </div>
      <p class="text-surface-600 dark:text-surface-400">
        {{ isEditMode ? 'Atualize as informações do espécime' : 'Cadastre um novo espécime no inventário florestal em 3 etapas' }}
      </p>
    </div>

    <!-- Stepper -->
    <p-stepper [value]="1" [linear]="true">
      <p-step-list>
          <p-step [value]="1">Upload de Imagens</p-step>
          <p-step [value]="2">Dados do Objeto</p-step>
          <p-step [value]="3">Informações da Espécie</p-step>
      </p-step-list>
      <p-step-panels>
        <p-step-panel [value]="1" header="Fotos">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">

              <!-- Files List -->
              <div *ngIf="selectedPhotos.length > 0" class="files-list-section">
                <div class="files-list-header">
                  <h4>{{ selectedPhotos.length }} {{ selectedPhotos.length === 1 ? 'arquivo' : 'arquivos' }} selecionado{{ selectedPhotos.length === 1 ? '' : 's' }}</h4>
                  <button 
                    type="button"
                    class="clear-all-btn"
                    (click)="clearAllPhotos(); fileUpload.clear()">
                    <i class="pi pi-trash"></i>
                    Limpar todos
                  </button>
                </div>

                <div class="files-grid">
                  <div *ngFor="let photo of selectedPhotos; let i = index" 
                       class="file-card">
                    
                    <!-- Image Preview -->
                    <div class="file-preview" (click)="openPhotoPreview(i)">
                      <img [src]="photo.preview" [alt]="photo.file.name" />
                      <div class="preview-overlay">
                        <i class="pi pi-eye"></i>
                      </div>
                    </div>

                    <!-- File Info -->
                    <div class="file-details">
                      <div class="file-header">
                        <div class="file-name" [title]="photo.file.name">
                          {{ photo.file.name }}
                        </div>
                        <button 
                          class="action-btn delete"
                          (click)="removePhoto(i); fileUpload.remove($event, i)"
                          type="button">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>

                      <div class="file-meta">
                        <span class="file-size">{{ formatFileSize(photo.file.size) }}</span>
                        <span class="separator">•</span>
                        <span class="file-type">{{ photo.file.type.split('/')[1].toUpperCase() }}</span>
                      </div>

                      <!-- Description Input -->
                      <div class="description-input">
                        <textarea
                          [(ngModel)]="selectedPhotos[i].description"
                          [ngModelOptions]="{standalone: true}"
                          placeholder="Adicionar descrição (opcional)..."
                          [maxlength]="200"
                          rows="2"
                        ></textarea>
                        <span class="char-count">{{ selectedPhotos[i].description?.length || 0 }}/200</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload Area -->
              <div class="upload-card">
                <div class="upload-dropzone" 
                     [class.has-files]="selectedPhotos.length > 0"
                     (dragover)="$event.preventDefault()" 
                     (drop)="$event.preventDefault()">
                  <div class="dropzone-content">
                    <div class="dropzone-icon">
                      <i class="pi pi-cloud-upload" [style]="{'font-size': '24pt'}"></i>
                    </div>
                    <h3 class="dropzone-title">Arraste e solte suas imagens aqui</h3>
                    <p class="dropzone-text">ou</p>
                  </div>
                  
                  <p-fileupload
                    #fileUpload
                    name="photos[]"
                    [multiple]="true"
                    accept="image/*"
                    [maxFileSize]="20000000"
                    (onSelect)="onPhotosSelect($event)"
                    (onClear)="onFileUploadClear()"
                    [showUploadButton]="false"
                    [showCancelButton]="false"
                    chooseLabel="Selecionar Arquivos"
                    chooseIcon="pi pi-folder-open"
                    class="modern-file-upload"
                  >
                    <ng-template pTemplate="content">
                      <div></div>
                    </ng-template>
                  </p-fileupload>
                  
                  <p class="dropzone-hint">PNG, JPG, WEBP até 20MB</p>
                </div>
              </div>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-outlined p-button-secondary" (click)="onCancel()"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="activateCallback(2)" [disabled]="selectedPhotos.length === 0" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 2: Dados do Objeto -->
        <p-step-panel [value]="2" header="Localização e Identificação">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-map-marker text-secondary"></i>
                      Informações de Localização e Identificação
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="objectForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Species -->
                      <div class="col-span-full">
                        <label for="speciesId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-leaf mr-2"></i>Espécie *
                        </label>
                        <p-select
                          id="speciesId"
                          formControlName="speciesId"
                          [options]="species"
                          placeholder="Selecione uma espécie"
                          [filter]="true"
                          filterPlaceholder="Buscar espécie..."
                          [showClear]="true"
                          [loading]="loadingData.species"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('speciesId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('speciesId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('speciesId', objectForm)" class="text-red-500">
                          {{ getFieldError('speciesId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Plot -->
                      <div class="col-span-full md:col-span-1">
                        <label for="plotId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-th-large mr-2"></i>Parcela *
                        </label>
                        <p-select
                          id="plotId"
                          formControlName="plotId"
                          [options]="plots"
                          placeholder="Selecione uma parcela"
                          [loading]="loadingData.plots"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('plotId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('plotId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('plotId', objectForm)" class="text-red-500">
                          {{ getFieldError('plotId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Observer -->
                      <div class="col-span-full md:col-span-1">
                        <label for="observerId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-user mr-2"></i>Observador *
                        </label>
                        <p-select
                          id="observerId"
                          formControlName="observerId"
                          [options]="users"
                          placeholder="Selecione um observador"
                          [filter]="true"
                          filterPlaceholder="Buscar observador..."
                          [showClear]="true"
                          [loading]="loadingData.users"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('observerId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('observerId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('observerId', objectForm)" class="text-red-500">
                          {{ getFieldError('observerId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Latitude -->
                      <div class="col-span-full md:col-span-1">
                        <label for="latitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-globe mr-2"></i>Latitude *
                        </label>
                        <p-inputNumber
                          id="latitude"
                          formControlName="latitude"
                          [minFractionDigits]="6"
                          [maxFractionDigits]="8"
                          [min]="-90"
                          [max]="90"
                          placeholder="-23.550520"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('latitude', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('latitude', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('latitude', objectForm)" class="text-red-500">
                          {{ getFieldError('latitude', objectForm) }}
                        </small>
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Valor entre -90 e 90
                        </small>
                      </div>
  
                      <!-- Longitude -->
                      <div class="col-span-full md:col-span-1">
                        <label for="longitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-globe mr-2"></i>Longitude *
                        </label>
                        <p-inputNumber
                          id="longitude"
                          formControlName="longitude"
                          [minFractionDigits]="6"
                          [maxFractionDigits]="8"
                          [min]="-180"
                          [max]="180"
                          placeholder="-46.633308"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('longitude', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('longitude', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('longitude', objectForm)" class="text-red-500">
                          {{ getFieldError('longitude', objectForm) }}
                        </small>
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Valor entre -180 e 180
                        </small>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(1)"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="onObjectFormNext(activateCallback)" [disabled]="objectForm.invalid" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 3: Informações da Espécie -->
        <p-step-panel [value]="3" header="Medições e Condição">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-chart-line text-secondary"></i>
                      Informações de Medição e Condição
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="speciesInfoForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Observation Date -->
                      <div class="col-span-full md:col-span-1">
                        <label for="observationDate" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-calendar mr-2"></i>Data de Observação
                        </label>
                        <p-datePicker
                          id="observationDate"
                          formControlName="observationDate"
                          [showTime]="true"
                          [showSeconds]="false"
                          dateFormat="dd/mm/yy"
                          placeholder="Selecione a data"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Se não informado, será utilizada a data atual
                        </small>
                      </div>
  
                      <!-- Condition -->
                      <div class="col-span-full md:col-span-1">
                        <label for="condition" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-heart mr-2"></i>Condição
                        </label>
                        <p-select
                          id="condition"
                          formControlName="condition"
                          [options]="conditionOptions"
                          placeholder="Selecione a condição"
                          [showClear]="true"
                          class="w-full"
                        />
                      </div>
  
                      <!-- Height -->
                      <div class="col-span-full md:col-span-1">
                        <label for="heightM" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-arrows-v mr-2"></i>Altura (metros)
                        </label>
                        <p-inputNumber
                          id="heightM"
                          formControlName="heightM"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" m"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Altura total do espécime em metros
                        </small>
                      </div>
  
                      <!-- DBH (Diameter at Breast Height) -->
                      <div class="col-span-full md:col-span-1">
                        <label for="dbmCm" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-circle mr-2"></i>DAP (cm)
                        </label>
                        <p-inputNumber
                          id="dbmCm"
                          formControlName="dbmCm"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" cm"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Diâmetro à Altura do Peito em centímetros
                        </small>
                      </div>
  
                      <!-- Age -->
                      <div class="col-span-full md:col-span-1">
                        <label for="ageYears" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-clock mr-2"></i>Idade (anos)
                        </label>
                        <p-inputNumber
                          id="ageYears"
                          formControlName="ageYears"
                          [min]="0"
                          suffix=" anos"
                          placeholder="0"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Idade estimada do espécime em anos
                        </small>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(2)"></button>
                <button
                  pButton
                  type="button"
                  label="Finalizar"
                  icon="pi pi-check"
                  class="p-button-success"
                  [loading]="loading"
                  (click)="onSubmit()"
                ></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-panels>
    </p-stepper>
  </div>
</div>

<!-- Photo Preview Dialog -->
<p-dialog
  [(visible)]="previewVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '1000px'}"
  styleClass="photo-preview-dialog"
  (onHide)="closePhotoPreview()">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <i class="pi pi-image text-xl"></i>
      <span class="font-semibold">Preview da Imagem</span>
      <span class="text-sm text-surface-500">({{ previewImageIndex + 1 }} de {{ selectedPhotos.length }})</span>
    </div>
  </ng-template>
  
  <div class="preview-content" *ngIf="selectedPhotos[previewImageIndex]">
    <img 
      [src]="selectedPhotos[previewImageIndex].preview" 
      [alt]="selectedPhotos[previewImageIndex].file.name"
      class="w-full h-auto rounded-lg"
    />
    <div class="preview-info">
      <p class="font-medium">{{ selectedPhotos[previewImageIndex].file.name }}</p>
      <p class="text-sm text-surface-500">
        {{ formatFileSize(selectedPhotos[previewImageIndex].file.size) }} • 
        {{ selectedPhotos[previewImageIndex].file.type.split('/')[1].toUpperCase() }}
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-between w-full">
      <button 
        pButton 
        type="button" 
        icon="pi pi-chevron-left" 
        label="Anterior"
        class="p-button-outlined"
        (click)="previousPreviewImage()"
        [disabled]="selectedPhotos.length <= 1">
      </button>
      <button 
        pButton 
        type="button" 
        icon="pi pi-chevron-right" 
        iconPos="right"
        label="Próxima"
        class="p-button-outlined"
        (click)="nextPreviewImage()"
        [disabled]="selectedPhotos.length <= 1">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Photo Preview Modal -->
<!-- <p-dialog
  [(visible)]="previewVisible"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [style]="{width: '90vw', maxWidth: '1200px'}"
  styleClass="photo-preview-dialog"
>
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full">
      <h3 class="text-xl font-semibold">
        Visualização de Foto ({{ previewImageIndex + 1 }}/{{ selectedPhotos.length }})
      </h3>
    </div>
  </ng-template>

  <div class="flex flex-col items-center" *ngIf="selectedPhotos[previewImageIndex]">
    <div class="relative w-full max-h-[70vh] flex items-center justify-center bg-surface-100 dark:bg-surface-900 rounded-lg overflow-hidden">
      <img 
        [src]="selectedPhotos[previewImageIndex].preview" 
        [alt]="selectedPhotos[previewImageIndex].file.name"
        class="max-w-full max-h-[70vh] object-contain"
      />
      
      <button
        *ngIf="selectedPhotos.length > 1"
        pButton
        type="button"
        icon="pi pi-chevron-left"
        class="p-button-rounded p-button-text absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 text-white hover:bg-black/70"
        (click)="previousPreviewImage()"
      ></button>
      <button
        *ngIf="selectedPhotos.length > 1"
        pButton
        type="button"
        icon="pi pi-chevron-right"
        class="p-button-rounded p-button-text absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 text-white hover:bg-black/70"
        (click)="nextPreviewImage()"
      ></button>
    </div>

    <div class="w-full mt-4 p-4 bg-surface-50 dark:bg-surface-800 rounded-lg">
      <p class="text-sm font-medium text-surface-900 dark:text-surface-0 mb-2">
        <i class="pi pi-file mr-2"></i>
        {{ selectedPhotos[previewImageIndex].file.name }}
      </p>
      <p class="text-xs text-surface-600 dark:text-surface-400 mb-3">
        <i class="pi pi-info-circle mr-2"></i>
        Tamanho: {{ formatFileSize(selectedPhotos[previewImageIndex].file.size) }}
      </p>
      <div *ngIf="selectedPhotos[previewImageIndex].description" class="mt-2">
        <p class="text-sm text-surface-700 dark:text-surface-300">
          <i class="pi pi-comment mr-2"></i>
          <strong>Descrição:</strong> {{ selectedPhotos[previewImageIndex].description }}
        </p>
      </div>
    </div>
  </div>
</p-dialog> -->
