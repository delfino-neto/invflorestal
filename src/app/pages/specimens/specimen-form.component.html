<div class="specimen-form-container p-6">
  <p-toast />

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-2 flex items-center gap-3">
        <i [style]="{'font-size': '2rem'}" class="material-symbols-outlined text-primary">potted_plant</i>
        {{ isEditMode ? 'Editar' : 'Novo' }} Espécime
      </div>
      <p class="text-surface-600 dark:text-surface-400">
        {{ isEditMode ? 'Atualize as informações do espécime' : 'Cadastre um novo espécime no inventário florestal em 3 etapas' }}
      </p>
    </div>

    <!-- Stepper -->
    <p-stepper [value]="1" [linear]="true">
      <p-step-list>
          <p-step [value]="1">Upload de Imagens</p-step>
          <p-step [value]="2">Geolocalização</p-step>
          <p-step [value]="3">Medições e Observação</p-step>
      </p-step-list>
      <p-step-panels>
        <p-step-panel [value]="1" header="Fotos">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">

              <!-- Files List -->
              <div *ngIf="selectedPhotos.length > 0" class="files-list-section">
                <div class="files-list-header">
                  <h4>{{ selectedPhotos.length }} {{ selectedPhotos.length === 1 ? 'arquivo' : 'arquivos' }} selecionado{{ selectedPhotos.length === 1 ? '' : 's' }}</h4>
                  <button 
                    type="button"
                    class="clear-all-btn"
                    (click)="clearAllPhotos(); fileUpload.clear()">
                    <i class="pi pi-trash"></i>
                    Limpar todos
                  </button>
                </div>

                <div class="files-grid">
                  <div *ngFor="let photo of selectedPhotos; let i = index" 
                       class="file-card">
                    
                    <!-- Image Preview -->
                    <div class="file-preview" (click)="openPhotoPreview(i)">
                      <img [src]="photo.preview" [alt]="photo.file.name" />
                      <div class="preview-overlay">
                        <i class="pi pi-eye"></i>
                      </div>
                    </div>

                    <!-- File Info -->
                    <div class="file-details">
                      <div class="file-header">
                        <div class="file-name" [title]="photo.file.name">
                          {{ photo.file.name }}
                        </div>
                        <button 
                          class="action-btn delete"
                          (click)="removePhoto(i); fileUpload.remove($event, i)"
                          type="button">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>

                      <div class="file-meta">
                        <span class="file-size">{{ formatFileSize(photo.file.size) }}</span>
                        <span class="separator">•</span>
                        <span class="file-type">{{ photo.file.type.split('/')[1].toUpperCase() }}</span>
                      </div>

                      <!-- Description Input -->
                      <div class="description-input">
                        <textarea
                          [(ngModel)]="selectedPhotos[i].description"
                          [ngModelOptions]="{standalone: true}"
                          placeholder="Adicionar descrição (opcional)..."
                          [maxlength]="200"
                          rows="2"
                        ></textarea>
                        <span class="char-count">{{ selectedPhotos[i].description?.length || 0 }}/200</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload Area -->
              <div class="upload-card">
                <div class="upload-dropzone" 
                     [class.has-files]="selectedPhotos.length > 0"
                     (dragover)="$event.preventDefault()" 
                     (drop)="$event.preventDefault()">
                  <div class="dropzone-content">
                    <div class="dropzone-icon">
                      <i class="pi pi-cloud-upload" [style]="{'font-size': '24pt'}"></i>
                    </div>
                    <h3 class="dropzone-title">Arraste e solte suas imagens aqui</h3>
                    <p class="dropzone-text">ou</p>
                  </div>
                  
                  <p-fileupload
                    #fileUpload
                    name="photos[]"
                    [multiple]="true"
                    accept="image/*"
                    [maxFileSize]="20000000"
                    (onSelect)="onPhotosSelect($event)"
                    (onClear)="onFileUploadClear()"
                    [showUploadButton]="false"
                    [showCancelButton]="false"
                    chooseLabel="Selecionar Arquivos"
                    chooseIcon="pi pi-folder-open"
                    class="modern-file-upload"
                  >
                    <ng-template pTemplate="content">
                      <div></div>
                    </ng-template>
                  </p-fileupload>
                  
                  <p class="dropzone-hint">PNG, JPG, WEBP até 20MB</p>
                </div>
              </div>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-outlined p-button-secondary" (click)="onCancel()"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="activateCallback(2)" [disabled]="selectedPhotos.length === 0" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 2: Geolocalização -->
        <p-step-panel [value]="2" header="Geolocalização">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-map-marker text-secondary"></i>
                      Localização Geográfica do Espécime
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="locationForm">
                    <div class="grid grid-cols-1 gap-6">
                      
                      <!-- Collection Area -->
                      <div class="col-span-full">
                        <label for="areaId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-map mr-2"></i>Área de Coleta *
                        </label>
                        <p-select
                          id="areaId"
                          formControlName="areaId"
                          [options]="collectionAreas"
                          placeholder="Selecione uma área de coleta"
                          [filter]="true"
                          filterPlaceholder="Buscar área..."
                          [showClear]="true"
                          [loading]="loadingData.areas"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('areaId', locationForm)"
                          [class.ng-dirty]="isFieldInvalid('areaId', locationForm)"
                        />
                        <small *ngIf="isFieldInvalid('areaId', locationForm)" class="text-red-500">
                          {{ getFieldError('areaId', locationForm) }}
                        </small>
                      </div>
                      
                      <!-- Plot -->
                      <div class="col-span-full">
                        <label for="plotId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-th-large mr-2"></i>Parcela (Plot) *
                        </label>
                        <p-select
                          id="plotId"
                          formControlName="plotId"
                          [options]="filteredPlots"
                          placeholder="Primeiro selecione uma área"
                          [disabled]="!locationForm.get('areaId')?.value"
                          [filter]="true"
                          filterPlaceholder="Buscar parcela..."
                          [showClear]="true"
                          [loading]="loadingData.plots"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('plotId', locationForm)"
                          [class.ng-dirty]="isFieldInvalid('plotId', locationForm)"
                        />
                        <small *ngIf="isFieldInvalid('plotId', locationForm)" class="text-red-500">
                          {{ getFieldError('plotId', locationForm) }}
                        </small>
                      </div>
                      
                      <!-- Coordenadas -->
                      <div class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Latitude -->
                        <div>
                          <label for="latitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                            <i class="pi pi-globe mr-2"></i>Latitude *
                          </label>
                          <p-inputNumber
                            id="latitude"
                            formControlName="latitude"
                            [minFractionDigits]="6"
                            [maxFractionDigits]="8"
                            [min]="-90"
                            [max]="90"
                            placeholder="-23.550520"
                            class="w-full"
                            [class.ng-invalid]="isFieldInvalid('latitude', locationForm)"
                            [class.ng-dirty]="isFieldInvalid('latitude', locationForm)"
                          />
                          <small *ngIf="isFieldInvalid('latitude', locationForm)" class="text-red-500">
                            {{ getFieldError('latitude', locationForm) }}
                          </small>
                          <small class="block text-surface-500 dark:text-surface-400 mt-1">
                            Valor entre -90 e 90
                          </small>
                        </div>
    
                        <!-- Longitude -->
                        <div>
                          <label for="longitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                            <i class="pi pi-globe mr-2"></i>Longitude *
                          </label>
                          <p-inputNumber
                            id="longitude"
                            formControlName="longitude"
                            [minFractionDigits]="6"
                            [maxFractionDigits]="8"
                            [min]="-180"
                            [max]="180"
                            placeholder="-46.633308"
                            class="w-full"
                            [class.ng-invalid]="isFieldInvalid('longitude', locationForm)"
                            [class.ng-dirty]="isFieldInvalid('longitude', locationForm)"
                          />
                          <small *ngIf="isFieldInvalid('longitude', locationForm)" class="text-red-500">
                            {{ getFieldError('longitude', locationForm) }}
                          </small>
                          <small class="block text-surface-500 dark:text-surface-400 mt-1">
                            Valor entre -180 e 180
                          </small>
                        </div>
                      </div>
                      
                      <!-- Mapa Interativo -->
                      <div class="col-span-full" *ngIf="locationForm.get('areaId')?.value && locationForm.get('plotId')?.value">
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                          <div class="flex items-start gap-3">
                            <i class="pi pi-info-circle text-blue-600 dark:text-blue-400 mt-1"></i>
                            <div>
                              <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-1">
                                Selecione a localização exata no mapa
                              </p>
                              <p class="text-sm text-blue-700 dark:text-blue-300">
                                Clique no mapa para definir as coordenadas precisas do espécime. A geometria da parcela selecionada é exibida em verde para referência.
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        <div class="border border-surface-200 dark:border-surface-700 rounded-lg overflow-hidden">
                          <app-map-visualizer
                            [geometries]="mapGeometries"
                            [markers]="currentMarker"
                            [enableMapClick]="true"
                            (mapClick)="onMapClick($event)"
                            height="450px"
                          ></app-map-visualizer>
                        </div>
                      </div>
                      
                      <!-- Placeholder quando não tem área/plot selecionado -->
                      <div *ngIf="!locationForm.get('areaId')?.value || !locationForm.get('plotId')?.value" 
                           class="col-span-full border-2 border-dashed border-surface-300 dark:border-surface-600 rounded-lg p-12 text-center">
                        <i class="pi pi-map text-5xl text-surface-400 dark:text-surface-500 mb-4"></i>
                        <p class="text-surface-700 dark:text-surface-300 font-medium mb-2">
                          Selecione a área e a parcela
                        </p>
                        <p class="text-surface-500 dark:text-surface-400 text-sm">
                          O mapa aparecerá automaticamente para seleção das coordenadas
                        </p>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(1)"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="onLocationFormNext(activateCallback)" [disabled]="locationForm.invalid" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 3: Medições e Observação -->
        <p-step-panel [value]="3" header="Medições e Observação">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-chart-line text-secondary"></i>
                      Medições, Observação e Identificação
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="speciesInfoForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Species -->
                      <div class="col-span-full">
                        <label for="speciesId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-leaf mr-2"></i>Espécie *
                        </label>
                        <p-select
                          id="speciesId"
                          formControlName="speciesId"
                          [options]="species"
                          placeholder="Selecione uma espécie"
                          [filter]="true"
                          filterPlaceholder="Buscar espécie..."
                          [showClear]="true"
                          [loading]="loadingData.species"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('speciesId', speciesInfoForm)"
                          [class.ng-dirty]="isFieldInvalid('speciesId', speciesInfoForm)"
                        />
                        <small *ngIf="isFieldInvalid('speciesId', speciesInfoForm)" class="text-red-500">
                          {{ getFieldError('speciesId', speciesInfoForm) }}
                        </small>
                      </div>
  
                      <!-- Observer -->
                      <div class="col-span-full">
                        <label for="observerId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-user mr-2"></i>Observador *
                        </label>
                        <p-select
                          id="observerId"
                          formControlName="observerId"
                          [options]="users"
                          placeholder="Selecione um observador"
                          [filter]="true"
                          filterPlaceholder="Buscar observador..."
                          [showClear]="true"
                          [loading]="loadingData.users"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('observerId', speciesInfoForm)"
                          [class.ng-dirty]="isFieldInvalid('observerId', speciesInfoForm)"
                        />
                        <small *ngIf="isFieldInvalid('observerId', speciesInfoForm)" class="text-red-500">
                          {{ getFieldError('observerId', speciesInfoForm) }}
                        </small>
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Pré-preenchido com o usuário atual
                        </small>
                      </div>
  
                      <div class="col-span-full">
                        <p-divider />
                      </div>
                      <!-- Observation Date -->
                      <div class="col-span-full md:col-span-1">
                        <label for="observationDate" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-calendar mr-2"></i>Data de Observação
                        </label>
                        <p-datePicker
                          id="observationDate"
                          formControlName="observationDate"
                          [showTime]="true"
                          [showSeconds]="false"
                          dateFormat="dd/mm/yy"
                          placeholder="Selecione a data"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Se não informado, será utilizada a data atual
                        </small>
                      </div>
  
                      <!-- Condition -->
                      <div class="col-span-full md:col-span-1">
                        <label for="condition" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-heart mr-2"></i>Condição
                        </label>
                        <p-select
                          id="condition"
                          formControlName="condition"
                          [options]="conditionOptions"
                          placeholder="Selecione a condição"
                          [showClear]="true"
                          class="w-full"
                        />
                      </div>
  
                      <!-- Height -->
                      <div class="col-span-full md:col-span-1">
                        <label for="heightM" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-arrows-v mr-2"></i>Altura (metros)
                        </label>
                        <p-inputNumber
                          id="heightM"
                          formControlName="heightM"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" m"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Altura total do espécime em metros
                        </small>
                      </div>
  
                      <!-- DBH (Diameter at Breast Height) -->
                      <div class="col-span-full md:col-span-1">
                        <label for="dbmCm" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-circle mr-2"></i>DAP (cm)
                        </label>
                        <p-inputNumber
                          id="dbmCm"
                          formControlName="dbmCm"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" cm"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Diâmetro à Altura do Peito em centímetros
                        </small>
                      </div>
  
                      <!-- Age -->
                      <div class="col-span-full md:col-span-1">
                        <label for="ageYears" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-clock mr-2"></i>Idade (anos)
                        </label>
                        <p-inputNumber
                          id="ageYears"
                          formControlName="ageYears"
                          [min]="0"
                          suffix=" anos"
                          placeholder="0"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Idade estimada do espécime em anos
                        </small>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(2)"></button>
                <button
                  pButton
                  type="button"
                  label="Finalizar"
                  icon="pi pi-check"
                  class="p-button-success"
                  [loading]="loading"
                  (click)="onSubmit()"
                ></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-panels>
    </p-stepper>
  </div>
</div>

<!-- Photo Preview Dialog -->
<p-dialog
  [(visible)]="previewVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '1000px'}"
  styleClass="photo-preview-dialog"
  (onHide)="closePhotoPreview()">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <i class="pi pi-image text-xl"></i>
      <span class="font-semibold">Preview da Imagem</span>
      <span class="text-sm text-surface-500">({{ previewImageIndex + 1 }} de {{ selectedPhotos.length }})</span>
    </div>
  </ng-template>
  
  <div class="preview-content" *ngIf="selectedPhotos[previewImageIndex]">
    <img 
      [src]="selectedPhotos[previewImageIndex].preview" 
      [alt]="selectedPhotos[previewImageIndex].file.name"
      class="w-full h-auto rounded-lg"
    />
    <div class="preview-info">
      <p class="font-medium">{{ selectedPhotos[previewImageIndex].file.name }}</p>
      <p class="text-sm text-surface-500">
        {{ formatFileSize(selectedPhotos[previewImageIndex].file.size) }} • 
        {{ selectedPhotos[previewImageIndex].file.type.split('/')[1].toUpperCase() }}
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-between w-full">
      <button 
        pButton 
        type="button" 
        icon="pi pi-chevron-left" 
        label="Anterior"
        class="p-button-outlined"
        (click)="previousPreviewImage()"
        [disabled]="selectedPhotos.length <= 1">
      </button>
      <button 
        pButton 
        type="button" 
        icon="pi pi-chevron-right" 
        iconPos="right"
        label="Próxima"
        class="p-button-outlined"
        (click)="nextPreviewImage()"
        [disabled]="selectedPhotos.length <= 1">
      </button>
    </div>
  </ng-template>
</p-dialog>

