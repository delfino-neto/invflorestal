<div class="specimen-form-container p-6">
  <p-toast />

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-2 flex items-center gap-3">
        <i [style]="{'font-size': '2rem'}" class="material-symbols-outlined text-primary">potted_plant</i>
        {{ isEditMode ? 'Editar' : 'Novo' }} Espécime
      </div>
      <p class="text-surface-600 dark:text-surface-400">
        {{ isEditMode ? 'Atualize as informações do espécime' : 'Cadastre um novo espécime no inventário florestal em 3 etapas' }}
      </p>
    </div>

    <!-- Stepper -->
    <p-stepper [value]="1" [linear]="true">
      <p-step-list>
          <p-step [value]="1">Upload de Imagens</p-step>
          <p-step [value]="2">Dados do Objeto</p-step>
          <p-step [value]="3">Informações da Espécie</p-step>
      </p-step-list>
      <p-step-panels>
        <p-step-panel [value]="1" header="Fotos">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <div class="border-2 border-surface-200 dark:border-surface-700 border-dashed rounded-lg bg-surface-50 dark:bg-surface-800 p-8">
                <div class="text-center mb-6">
                  <i [style]="{'font-size': '3rem'}" class="material-symbols-outlined text-primary">photo_camera</i>
                  <h3 class="text-2xl font-semibold text-surface-900 dark:text-surface-0 mb-2">
                    Adicione fotos do espécime
                  </h3>
                  <p class="text-surface-600 dark:text-surface-400">
                    Você pode adicionar fotos agora ou pular esta etapa
                  </p>
                </div>
  
                <p-fileupload
                  name="photos[]"
                  [multiple]="true"
                  accept="image/*"
                  [maxFileSize]="10000000"
                  (onSelect)="onPhotosSelect($event)"
                  (onRemove)="onPhotoRemove($event)"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  chooseLabel="Selecionar Fotos"
                  chooseIcon="pi pi-images"
                  class="w-full"
                >
                  <ng-template pTemplate="content">
                    <div *ngIf="selectedPhotos.length > 0" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                      <div *ngFor="let photo of selectedPhotos; let i = index" class="relative group">
                        <img [src]="photo.preview" class="w-full h-40 object-cover rounded-lg shadow-md" />
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                          <button
                            pButton
                            type="button"
                            icon="pi pi-trash"
                            class="p-button-danger p-button-rounded"
                            (click)="removePhoto(i)"
                          ></button>
                        </div>
                        <div class="mt-2">
                          <input
                            type="text"
                            pInputText
                            [(ngModel)]="photo.description"
                            placeholder="Descrição (opcional)"
                            class="w-full text-sm"
                          />
                        </div>
                      </div>
                    </div>
                    <div *ngIf="selectedPhotos.length === 0" class="text-center py-8 text-surface-500">
                      Nenhuma foto selecionada
                    </div>
                  </ng-template>
                </p-fileupload>
              </div>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-outlined p-button-secondary" (click)="onCancel()"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="activateCallback(2)" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 2: Dados do Objeto -->
        <p-step-panel [value]="2" header="Localização e Identificação">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-map-marker text-secondary"></i>
                      Informações de Localização e Identificação
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="objectForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Species -->
                      <div class="col-span-full">
                        <label for="speciesId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-leaf mr-2"></i>Espécie *
                        </label>
                        <p-select
                          id="speciesId"
                          formControlName="speciesId"
                          [options]="species"
                          placeholder="Selecione uma espécie"
                          [filter]="true"
                          filterPlaceholder="Buscar espécie..."
                          [showClear]="true"
                          [loading]="loadingData.species"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('speciesId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('speciesId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('speciesId', objectForm)" class="text-red-500">
                          {{ getFieldError('speciesId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Plot -->
                      <div class="col-span-full md:col-span-1">
                        <label for="plotId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-th-large mr-2"></i>Parcela *
                        </label>
                        <p-select
                          id="plotId"
                          formControlName="plotId"
                          [options]="plots"
                          placeholder="Selecione uma parcela"
                          [filter]="true"
                          filterPlaceholder="Buscar parcela..."
                          [showClear]="true"
                          [loading]="loadingData.plots"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('plotId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('plotId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('plotId', objectForm)" class="text-red-500">
                          {{ getFieldError('plotId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Observer -->
                      <div class="col-span-full md:col-span-1">
                        <label for="observerId" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-user mr-2"></i>Observador *
                        </label>
                        <p-select
                          id="observerId"
                          formControlName="observerId"
                          [options]="users"
                          placeholder="Selecione um observador"
                          [filter]="true"
                          filterPlaceholder="Buscar observador..."
                          [showClear]="true"
                          [loading]="loadingData.users"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('observerId', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('observerId', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('observerId', objectForm)" class="text-red-500">
                          {{ getFieldError('observerId', objectForm) }}
                        </small>
                      </div>
  
                      <!-- Latitude -->
                      <div class="col-span-full md:col-span-1">
                        <label for="latitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-globe mr-2"></i>Latitude *
                        </label>
                        <p-inputNumber
                          id="latitude"
                          formControlName="latitude"
                          [minFractionDigits]="6"
                          [maxFractionDigits]="8"
                          [min]="-90"
                          [max]="90"
                          placeholder="-23.550520"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('latitude', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('latitude', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('latitude', objectForm)" class="text-red-500">
                          {{ getFieldError('latitude', objectForm) }}
                        </small>
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Valor entre -90 e 90
                        </small>
                      </div>
  
                      <!-- Longitude -->
                      <div class="col-span-full md:col-span-1">
                        <label for="longitude" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-globe mr-2"></i>Longitude *
                        </label>
                        <p-inputNumber
                          id="longitude"
                          formControlName="longitude"
                          [minFractionDigits]="6"
                          [maxFractionDigits]="8"
                          [min]="-180"
                          [max]="180"
                          placeholder="-46.633308"
                          class="w-full"
                          [class.ng-invalid]="isFieldInvalid('longitude', objectForm)"
                          [class.ng-dirty]="isFieldInvalid('longitude', objectForm)"
                        />
                        <small *ngIf="isFieldInvalid('longitude', objectForm)" class="text-red-500">
                          {{ getFieldError('longitude', objectForm) }}
                        </small>
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Valor entre -180 e 180
                        </small>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(1)"></button>
                <button pButton type="button" label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="onObjectFormNext(activateCallback)" [disabled]="objectForm.invalid" class="p-button-primary"></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
  
        <!-- Step 3: Informações da Espécie -->
        <p-step-panel [value]="3" header="Medições e Condição">
          <ng-template pTemplate="content" let-activateCallback="activateCallback" let-index="index">
            <div class="flex flex-col h-full">
              <p-card>
                <ng-template pTemplate="header">
                  <div class="p-4">
                    <div class="text-xl font-semibold text-surface-500 dark:text-surface-0 flex items-center gap-2">
                      <i class="pi pi-chart-line text-secondary"></i>
                      Informações de Medição e Condição
                    </div>
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="speciesInfoForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Observation Date -->
                      <div class="col-span-full md:col-span-1">
                        <label for="observationDate" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-calendar mr-2"></i>Data de Observação
                        </label>
                        <p-datePicker
                          id="observationDate"
                          formControlName="observationDate"
                          [showTime]="true"
                          [showSeconds]="false"
                          dateFormat="dd/mm/yy"
                          placeholder="Selecione a data"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Se não informado, será utilizada a data atual
                        </small>
                      </div>
  
                      <!-- Condition -->
                      <div class="col-span-full md:col-span-1">
                        <label for="condition" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-heart mr-2"></i>Condição
                        </label>
                        <p-select
                          id="condition"
                          formControlName="condition"
                          [options]="conditionOptions"
                          placeholder="Selecione a condição"
                          [showClear]="true"
                          class="w-full"
                        />
                      </div>
  
                      <!-- Height -->
                      <div class="col-span-full md:col-span-1">
                        <label for="heightM" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-arrows-v mr-2"></i>Altura (metros)
                        </label>
                        <p-inputNumber
                          id="heightM"
                          formControlName="heightM"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" m"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Altura total do espécime em metros
                        </small>
                      </div>
  
                      <!-- DBH (Diameter at Breast Height) -->
                      <div class="col-span-full md:col-span-1">
                        <label for="dbmCm" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-circle mr-2"></i>DAP (cm)
                        </label>
                        <p-inputNumber
                          id="dbmCm"
                          formControlName="dbmCm"
                          [minFractionDigits]="2"
                          [maxFractionDigits]="2"
                          [min]="0"
                          suffix=" cm"
                          placeholder="0.00"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Diâmetro à Altura do Peito em centímetros
                        </small>
                      </div>
  
                      <!-- Age -->
                      <div class="col-span-full md:col-span-1">
                        <label for="ageYears" class="block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-2">
                          <i class="pi pi-clock mr-2"></i>Idade (anos)
                        </label>
                        <p-inputNumber
                          id="ageYears"
                          formControlName="ageYears"
                          [min]="0"
                          suffix=" anos"
                          placeholder="0"
                          class="w-full"
                        />
                        <small class="block text-surface-500 dark:text-surface-400 mt-1">
                          Idade estimada do espécime em anos
                        </small>
                      </div>
                    </div>
                  </form>
                </ng-template>
              </p-card>
  
              <div class="flex justify-between pt-6">
                <button pButton type="button" label="Anterior" icon="pi pi-arrow-left" class="p-button-outlined" (click)="activateCallback(2)"></button>
                <button
                  pButton
                  type="button"
                  label="Finalizar"
                  icon="pi pi-check"
                  class="p-button-success"
                  [loading]="loading"
                  (click)="onSubmit()"
                ></button>
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-panels>
    </p-stepper>
  </div>
</div>
